<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>winkNLP Loading Test</title>
</head>
<body>
  <h1>winkNLP Loading Test</h1>
  <div id="status">Loading...</div>
  <div id="output"></div>
  
  <script>
    // Global error tracking and script loading status
    window.scriptErrors = [];
    window.scriptsLoaded = {
      winkNLP: false,
      model: false
    };
    
    function handleScriptError(script, error) {
      console.error('Script failed to load:', script.src, error);
      window.scriptErrors.push({ script: script.src, error: error.message });
      document.getElementById('status').textContent = 'Error loading scripts';
    }
    
    // Load scripts with error handling and proper global exposure
    function loadScript(src, onLoad, onError) {
      const script = document.createElement('script');
      script.src = src;
      script.onload = onLoad;
      script.onerror = (e) => onError(e);
      document.head.appendChild(script);
    }
    
    // Load winkNLP core library from jsDelivr CDN
    loadScript('https://cdn.jsdelivr.net/npm/wink-nlp@2.4.0/dist/wink-nlp.min.js', 
      () => {
        console.log('winkNLP core library loaded successfully');
        window.scriptsLoaded.winkNLP = true;
        document.getElementById('status').textContent = 'winkNLP core loaded, loading model...';
        
        // Now load the English language model
        loadScript('https://cdn.jsdelivr.net/npm/wink-eng-lite-web-model@1.0.0/dist/wink-eng-lite-web-model.min.js',
          () => {
            console.log('winkNLP English model loaded successfully');
            window.scriptsLoaded.model = true;
            document.getElementById('status').textContent = 'Model loaded, initializing...';
            
            // Initialize winkNLP with the model
            try {
              if (window.winkNLP && window.model) {
                // Create the NLP instance and expose helpers globally
                window.nlpInstance = window.winkNLP(window.model);
                window.its = window.nlpInstance.its;
                window.as = window.nlpInstance.as;
                console.log('winkNLP fully initialized with model');
                document.getElementById('status').textContent = 'winkNLP fully operational!';
                
                // Test the NLP functionality
                testNLP();
              }
            } catch (error) {
              console.error('Error initializing winkNLP with model:', error);
              window.scriptErrors.push({ script: 'winkNLP initialization', error: error.message });
              document.getElementById('status').textContent = 'Initialization failed: ' + error.message;
            }
          },
          (e) => {
            console.warn('Primary winkNLP model CDN failed, trying alternative...');
            loadScript('https://unpkg.com/wink-eng-lite-web-model@1.0.0/dist/wink-eng-lite-web-model.min.js',
              () => {
                console.log('winkNLP model loaded from alternative CDN');
                window.scriptsLoaded.model = true;
                document.getElementById('status').textContent = 'Model loaded (alternative), initializing...';
                
                // Initialize winkNLP with the model
                try {
                  if (window.winkNLP && window.model) {
                    window.nlpInstance = window.winkNLP(window.model);
                    window.its = window.nlpInstance.its;
                    window.as = window.nlpInstance.as;
                    console.log('winkNLP fully initialized with model (alternative CDN)');
                    document.getElementById('status').textContent = 'winkNLP fully operational (alternative)!';
                    
                    // Test the NLP functionality
                    testNLP();
                  }
                } catch (error) {
                  console.error('Error initializing winkNLP with model:', error);
                  window.scriptErrors.push({ script: 'winkNLP initialization (alternative)', error: error.message });
                  document.getElementById('status').textContent = 'Initialization failed: ' + error.message;
                }
              },
              (e2) => handleScriptError({ src: 'winkNLP model (all sources)' }, e2)
            );
          }
        );
      },
      (e) => {
        console.warn('Primary winkNLP CDN failed, trying alternative...');
        loadScript('https://unpkg.com/wink-nlp@2.4.0/dist/wink-nlp.min.js',
          () => {
            console.log('winkNLP loaded from alternative CDN');
            window.scriptsLoaded.winkNLP = true;
            document.getElementById('status').textContent = 'winkNLP loaded (alternative), loading model...';
            
            // Load model from alternative CDN as well
            loadScript('https://unpkg.com/wink-eng-lite-web-model@1.0.0/dist/wink-eng-lite-web-model.min.js',
              () => {
                console.log('winkNLP model loaded from alternative CDN');
                window.scriptsLoaded.model = true;
                document.getElementById('status').textContent = 'Model loaded (alternative), initializing...';
                
                // Initialize winkNLP with the model
                try {
                  if (window.winkNLP && window.model) {
                    window.nlpInstance = window.winkNLP(window.model);
                    window.its = window.nlpInstance.its;
                    window.as = window.nlpInstance.as;
                    console.log('winkNLP fully initialized with model (alternative CDN)');
                    document.getElementById('status').textContent = 'winkNLP fully operational (alternative)!';
                    
                    // Test the NLP functionality
                    testNLP();
                  }
                } catch (error) {
                  console.error('Error initializing winkNLP with model:', error);
                  window.scriptErrors.push({ script: 'winkNLP initialization (alternative)', error: error.message });
                  document.getElementById('status').textContent = 'Initialization failed: ' + error.message;
                }
              },
              (e2) => handleScriptError({ src: 'winkNLP model (alternative)' }, e2)
            );
          },
          (e2) => handleScriptError({ src: 'winkNLP (all sources)' }, e2)
        );
      }
    );
    
    // Test NLP functionality
    function testNLP() {
      try {
        const testText = 'Hello World! How are you today? Tell me a joke.';
        const doc = window.nlpInstance.readDoc(testText);
        
        const output = document.getElementById('output');
        output.innerHTML = `
          <h3>NLP Test Results:</h3>
          <p><strong>Input:</strong> ${testText}</p>
          <p><strong>Sentences:</strong> ${doc.sentences().out().join(' | ')}</p>
          <p><strong>Tokens:</strong> ${doc.tokens().out().join(', ')}</p>
          <p><strong>Token Types:</strong> ${JSON.stringify(doc.tokens().out(window.its.type, window.as.freqTable))}</p>
          <p><strong>Entities:</strong> ${JSON.stringify(doc.entities().out(window.its.detail))}</p>
        `;
        
        console.log('NLP test completed successfully');
      } catch (error) {
        console.error('NLP test failed:', error);
        document.getElementById('output').innerHTML = `<p style="color: red;">NLP test failed: ${error.message}</p>`;
      }
    }
    
    // Set up periodic status checking for debugging
    setInterval(() => {
      if (window.nlpInstance && window.its && window.as) {
        console.log('winkNLP status: Fully operational');
      } else {
        console.log('winkNLP status:', {
          nlpInstance: !!window.nlpInstance,
          its: !!window.its,
          as: !!window.as,
          winkNLP: !!window.winkNLP,
          model: !!window.model
        });
      }
    }, 5000);
  </script>
</body>
</html>
